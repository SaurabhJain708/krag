version: '3.8'

x-common-env: &common-env
  # Use container service name for Docker, .env file uses localhost for host commands
  DATABASE_URL: postgresql://supabase_admin:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
  DIRECT_URL: postgresql://supabase_admin:${POSTGRES_PASSWORD}@supabase-db:5432/postgres
  REDIS_URL: ${REDIS_URL}
  MODAL_TOKEN_ID: ${MODAL_TOKEN_ID}
  MODAL_TOKEN_SECRET: ${MODAL_TOKEN_SECRET}
  EXA_API_KEY: ${EXA_API_KEY}
  ENCRYPTION_KEY: ${ENCRYPTION_KEY}
  ENCRYPTION_KEY_STORAGE: ${ENCRYPTION_KEY_STORAGE}
  SUPABASE_URL: ${SUPABASE_URL}
  SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}

services:
  # Supabase PostgreSQL (Local Development)
  supabase-db:
    image: supabase/postgres:15.1.0.117
    container_name: krag-supabase-db
    ports:
      - "${SUPABASE_DB_PORT:-54322}:5432"
    environment:
      POSTGRES_HOST: /var/run/postgresql
      PGPORT: 5432
      POSTGRES_PORT: 5432
      PGDATABASE: postgres
      PGUSER: supabase_admin
      POSTGRES_USER: supabase_admin
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXP: ${JWT_EXP}
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U supabase_admin"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - krag-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: krag-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - krag-network

  # Ingestion Worker (3 instances)
  ingestion-worker:
    build:
      context: .
      dockerfile: apps/ingestion-worker/Dockerfile
    environment:
      <<: *common-env
    depends_on:
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - krag-network
    deploy:
      replicas: 3

  # Retrieval Worker
  retrieval-worker:
    build:
      context: .
      dockerfile: apps/retrieval-worker/Dockerfile
    container_name: krag-retrieval-worker
    environment:
      <<: *common-env
      RETRIEVAL_API: ${RETRIEVAL_API}
    depends_on:
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - krag-network

  # Web App (Next.js)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NODE_ENV: ${NODE_ENV:-production}
        ENCRYPTION_KEY_STORAGE: ${ENCRYPTION_KEY_STORAGE}
        DATABASE_URL: ${DATABASE_URL:-postgresql://placeholder:placeholder@localhost:5432/placeholder}
        BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-placeholder-secret-for-build-only}
        SUPABASE_URL: ${SUPABASE_URL:-https://placeholder.supabase.co}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-placeholder-key}
        REDIS_URL: ${REDIS_URL:-redis://placeholder:6379}
    container_name: krag-web
    ports:
      - "${WEB_PORT:-3001}:3001"
    environment:
      <<: *common-env
      NODE_ENV: ${NODE_ENV:-production}
      SUPABASE_KEY: ${SUPABASE_KEY}
      BETTER_AUTH_URL: ${BETTER_AUTH_URL:-http://localhost:3001/api/auth}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      RETRIEVAL_API: ${RETRIEVAL_API}
    depends_on:
      supabase-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      retrieval-worker:
        condition: service_started
    restart: unless-stopped
    networks:
      - krag-network

volumes:
  supabase_db_data:
  redis_data:

networks:
  krag-network:
    driver: bridge
