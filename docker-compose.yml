x-common-env: &common-env
  # Use container service name for Docker, .env file uses localhost for host commands
  BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
  DATABASE_URL: ${DATABASE_URL}
  DIRECT_URL: ${DIRECT_URL}
  SUPABASE_URL: ${SUPABASE_URL}
  SUPABASE_KEY: ${SUPABASE_KEY}
  SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
  NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
  REDIS_URL: ${REDIS_URL}
  MODAL_TOKEN_ID: ${MODAL_TOKEN_ID}
  MODAL_TOKEN_SECRET: ${MODAL_TOKEN_SECRET}
  EXA_API_KEY: ${EXA_API_KEY}
  NODE_ENV: ${NODE_ENV}
  RETRIEVAL_API: ${RETRIEVAL_API}
  ENCRYPTION_KEY: ${ENCRYPTION_KEY}
  ENCRYPTION_KEY_STORAGE: ${ENCRYPTION_KEY_STORAGE}
  BETTER_AUTH_URL: ${BETTER_AUTH_URL}

services:
  # Redis
  redis:
    image: redis:7-alpine
    container_name: krag-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - krag-network

  # Ingestion Worker (3 instances)
  ingestion-worker:
    build:
      context: .
      dockerfile: apps/ingestion-worker/Dockerfile
    environment:
      <<: *common-env
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - krag-network
    deploy:
      replicas: 3

  # Retrieval Worker
  retrieval-worker:
    build:
      context: .
      dockerfile: apps/retrieval-worker/Dockerfile
    container_name: krag-retrieval-worker
    environment:
      <<: *common-env
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - krag-network

  # Web App (Next.js)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NODE_ENV: ${NODE_ENV:-production}
        ENCRYPTION_KEY_STORAGE: ${ENCRYPTION_KEY_STORAGE}
        DATABASE_URL: ${DATABASE_URL:-postgresql://placeholder:placeholder@localhost:5432/placeholder}
        BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET:-placeholder-secret-for-build-only}
        REDIS_URL: ${REDIS_URL:-redis://placeholder:6379}
        SUPABASE_URL: ${SUPABASE_URL:-https://placeholder.supabase.co}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-placeholder-key-for-build-only}
    container_name: krag-web
    ports:
      - "${WEB_PORT:-3001}:3001"
    environment:
      <<: *common-env
    depends_on:
      redis:
        condition: service_healthy
      retrieval-worker:
        condition: service_started
    restart: unless-stopped
    networks:
      - krag-network

volumes:
  redis_data:

networks:
  krag-network:
    driver: bridge
